<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COLMO æ•°æ®å¤„ç†å·¥å…·</title>
    <!-- åº“åŠ è½½æ£€æŸ¥ -->
    <script>
        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½çš„è¾…åŠ©å‡½æ•°
        function waitForLibrary(libraryName, checkFunc, timeout = 10000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                function check() {
                    if (checkFunc()) {
                        console.log(`âœ… ${libraryName} å·²åŠ è½½`);
                        resolve();
                    } else if (Date.now() - startTime > timeout) {
                        reject(new Error(`${libraryName} åŠ è½½è¶…æ—¶`));
                    } else {
                        setTimeout(check, 100);
                    }
                }
                check();
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥æ‰€æœ‰åº“
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('=== é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥åº“æ–‡ä»¶ ===');
            console.log('XLSX:', typeof XLSX);
            console.log('JSZip:', typeof JSZip);
            console.log('saveAs:', typeof saveAs);

            try {
                await waitForLibrary('XLSX', () => typeof XLSX !== 'undefined');
                await waitForLibrary('JSZip', () => typeof JSZip !== 'undefined' || typeof window.JSZip !== 'undefined');
                await waitForLibrary('FileSaver', () => typeof saveAs !== 'undefined');
                console.log('âœ… æ‰€æœ‰å¿…éœ€çš„åº“å·²åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('âŒ åº“åŠ è½½å¤±è´¥:', error);
                alert('éƒ¨åˆ†åº“åŠ è½½å¤±è´¥ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
            }
        });
    </script>
    <!-- æœ¬åœ°åº“æ–‡ä»¶ - ä¸ä¾èµ– CDNï¼Œç¡®ä¿ 100% å¯ç”¨ -->
    <script src=""></script>
<script src=""></script>
<script src=""></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-black: #0A0A0A;
            --secondary-black: #1A1A1A;
            --pure-white: #FFFFFF;
            --off-white: #FAFAFA;
            --light-gray: #E8E8E8;
            --medium-gray: #A0A0A0;
            --dark-gray: #4A4A4A;
            --gold-accent: #C8A96C;
            --gold-light: #D4BC7E;
            --gold-dark: #B89B5F;
            --success: #1A1A1A;
            --border-subtle: rgba(26, 26, 26, 0.08);
            --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-elegant: 0 8px 32px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Noto Serif SC', 'Playfair Display', serif;
            background: linear-gradient(135deg, #FAFAFA 0%, #F0F0F0 100%);
            color: var(--secondary-black);
            line-height: 1.7;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animated background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(var(--border-subtle) 1px, transparent 1px),
                linear-gradient(90deg, var(--border-subtle) 1px, transparent 1px);
            background-size: 60px 60px;
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 40px;
            position: relative;
            z-index: 1;
            animation: fadeInUp 0.8s ease-out;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 1s ease-out;
        }

        .header-title {
            font-family: 'Playfair Display', 'Noto Serif SC', serif;
            font-size: 48px;
            font-weight: 300;
            color: var(--primary-black);
            margin-bottom: 16px;
            letter-spacing: 0.02em;
            position: relative;
            display: inline-block;
        }

        .header-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold-accent), transparent);
        }

        .header-subtitle {
            font-size: 15px;
            font-weight: 400;
            color: var(--medium-gray);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        /* Function Selector */
        .function-selector {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeIn 1.2s ease-out;
        }

        .selector-label {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--medium-gray);
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .function-select-wrapper {
            display: inline-block;
            position: relative;
        }

        .function-select {
            width: 100%;
            min-width: 400px;
            padding: 16px 24px;
            font-family: 'Noto Serif SC', serif;
            font-size: 15px;
            font-weight: 400;
            border: 1px solid var(--light-gray);
            background: var(--pure-white);
            color: var(--secondary-black);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
            border-radius: 0;
            position: relative;
            letter-spacing: 0.02em;
        }

        .function-select:hover {
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 3px rgba(200, 169, 108, 0.08);
        }

        .function-select:focus {
            outline: none;
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 3px rgba(200, 169, 108, 0.12);
        }

        .function-select-wrapper::after {
            content: '';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-right: 2px solid var(--gold-accent);
            border-bottom: 2px solid var(--gold-accent);
            transform: translateY(-60%) rotate(45deg);
            pointer-events: none;
            transition: transform 0.3s ease;
        }

        .function-select-wrapper:hover::after {
            transform: translateY(-60%) rotate(225deg);
        }

        /* Card */
        .card {
            background: var(--pure-white);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-elegant);
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: translateY(30px);
            animation: cardEnter 0.8s ease-out forwards;
        }

        .card:hover {
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 32px 40px;
            border-bottom: 1px solid var(--border-subtle);
            background: linear-gradient(180deg, var(--off-white) 0%, var(--pure-white) 100%);
            position: relative;
        }

        .card-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--light-gray), transparent);
        }

        .card-title {
            font-family: 'Playfair Display', 'Noto Serif SC', serif;
            font-size: 26px;
            font-weight: 400;
            color: var(--primary-black);
            letter-spacing: 0.02em;
        }

        .card-body {
            padding: 40px;
        }

        /* Upload Area */
        .upload-area {
            border: 1px solid var(--light-gray);
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 30px;
            background: var(--pure-white);
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(200, 169, 108, 0.03), transparent);
            transition: left 0.6s ease;
        }

        .upload-area:hover::before {
            left: 100%;
        }

        .upload-area:hover {
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 1px var(--gold-accent), 0 8px 24px rgba(200, 169, 108, 0.08);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: var(--gold-accent);
            background: linear-gradient(135deg, rgba(200, 169, 108, 0.02) 0%, rgba(200, 169, 108, 0.05) 100%);
            box-shadow: 0 0 0 2px var(--gold-accent), 0 12px 32px rgba(200, 169, 108, 0.12);
        }

        .upload-icon {
            font-size: 56px;
            margin-bottom: 24px;
            opacity: 0.3;
            transition: all 0.4s ease;
            display: inline-block;
        }

        .upload-area:hover .upload-icon {
            opacity: 0.6;
            transform: scale(1.1);
        }

        .upload-text {
            font-size: 16px;
            font-weight: 400;
            color: var(--secondary-black);
            margin-bottom: 12px;
            letter-spacing: 0.02em;
        }

        .upload-hint {
            font-size: 13px;
            color: var(--medium-gray);
            letter-spacing: 0.03em;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: var(--off-white);
            border: 1px solid var(--light-gray);
            margin-bottom: 12px;
            transition: all 0.3s ease;
            animation: slideInRight 0.4s ease-out;
        }

        .file-item:hover {
            background: var(--pure-white);
            border-color: var(--gold-accent);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .file-icon {
            font-size: 28px;
            margin-right: 16px;
            opacity: 0.4;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--secondary-black);
            margin-bottom: 4px;
        }

        .file-size {
            font-size: 12px;
            color: var(--medium-gray);
        }

        .file-remove {
            color: var(--medium-gray);
            cursor: pointer;
            padding: 8px 12px;
            font-size: 18px;
            transition: all 0.3s ease;
            opacity: 0.5;
        }

        .file-remove:hover {
            color: var(--secondary-black);
            opacity: 1;
            transform: scale(1.1);
        }

        /* Button */
        .btn {
            display: inline-block;
            padding: 14px 32px;
            font-family: 'Noto Serif SC', serif;
            font-size: 14px;
            font-weight: 400;
            border: none;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--secondary-black);
            color: var(--pure-white);
            border: 1px solid var(--secondary-black);
        }

        .btn-primary:hover {
            background: var(--primary-black);
            border-color: var(--primary-black);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: var(--light-gray);
            border-color: var(--light-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary:disabled::before {
            display: none;
        }

        .btn-secondary {
            background: var(--pure-white);
            border: 1px solid var(--light-gray);
            color: var(--secondary-black);
        }

        .btn-secondary:hover {
            border-color: var(--gold-accent);
            color: var(--gold-accent);
            box-shadow: 0 2px 12px rgba(200, 169, 108, 0.1);
        }

        .btn-success {
            background: var(--secondary-black);
            color: var(--pure-white);
            border: 1px solid var(--secondary-black);
        }

        .btn-success:hover {
            background: var(--primary-black);
            border-color: var(--primary-black);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .btn-download-single {
            background: var(--gold-accent);
            color: var(--pure-white);
            border: 1px solid var(--gold-accent);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Serif SC', serif;
        }

        .btn-download-single:hover {
            background: var(--gold-dark);
            border-color: var(--gold-dark);
            box-shadow: 0 2px 8px rgba(200, 169, 108, 0.3);
            transform: translateY(-1px);
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 32px;
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 13px;
            font-weight: 400;
            letter-spacing: 0.03em;
            color: var(--dark-gray);
        }

        .progress-bar-bg {
            height: 2px;
            background: var(--light-gray);
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-black), var(--gold-accent));
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: translateX(-100%);
            animation: shimmer 1.5s infinite;
        }

        /* Results */
        .results {
            margin-top: 32px;
            display: none;
            animation: fadeInUp 0.6s ease-out;
        }

        .results-summary {
            background: var(--off-white);
            border: 1px solid var(--light-gray);
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .results-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--secondary-black);
        }

        .results-summary.warning::before {
            background: var(--gold-accent);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item:hover {
            padding-left: 8px;
            border-bottom-color: var(--light-gray);
        }

        .result-label {
            font-size: 14px;
            color: var(--dark-gray);
        }

        .result-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--secondary-black);
        }
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .result-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Config Section */
        /* Config Section */
        .config-section {
            margin-top: 32px;
            padding: 28px;
            background: var(--off-white);
            border: 1px solid var(--border-subtle);
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--light-gray);
        }

        .config-title {
            font-family: 'Playfair Display', 'Noto Serif SC', serif;
            font-size: 18px;
            font-weight: 400;
            color: var(--secondary-black);
            letter-spacing: 0.02em;
        }

        .config-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .config-actions .btn {
            padding: 10px 20px;
            font-size: 12px;
        }

        /* Merchant List */
        .merchant-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .merchant-card {
            background: var(--pure-white);
            border: 1px solid var(--light-gray);
            padding: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .merchant-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--secondary-black);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .merchant-card:hover {
            border-color: var(--gold-accent);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }

        .merchant-card:hover::before {
            transform: scaleY(1);
        }

        .merchant-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--secondary-black);
            margin-bottom: 8px;
        }

        .merchant-store-count {
            font-size: 13px;
            color: var(--medium-gray);
        }

        .merchant-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .merchant-actions .btn {
            padding: 6px 12px;
            font-size: 11px;
        }

        /* Alert Messages */
        .alert {
            padding: 16px 20px;
            border-radius: 0;
            margin-bottom: 20px;
            font-size: 14px;
            border-left: 3px solid;
            background: var(--off-white);
        }

        .alert-success {
            border-left-color: var(--success);
            color: var(--dark-gray);
        }

        .alert-error {
            border-left-color: var(--secondary-black);
            color: var(--dark-gray);
        }

        .alert-warning {
            border-left-color: var(--gold-accent);
            color: var(--dark-gray);
        }

        /* Rules Table */
        .rules-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 20px;
        }

        .rules-table th,
        .rules-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
        }

        .rules-table th {
            background: var(--off-white);
            font-weight: 400;
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--dark-gray);
            border-bottom: 2px solid var(--light-gray);
        }

        .rules-table tr:hover td {
            background: var(--off-white);
        }

        .rules-table input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--light-gray);
            font-family: 'Noto Serif SC', serif;
            font-size: 13px;
            background: var(--pure-white);
            transition: all 0.3s ease;
        }

        .rules-table input:focus {
            outline: none;
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 2px rgba(200, 169, 108, 0.08);
        }

        /* Hidden by default */
        .hidden {
            display: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Alert */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-success {
            background: #F6FFED;
            border: 1px solid #B7EB8F;
            color: #389E0D;
        }

        .alert-error {
            background: #FFF2F0;
            border: 1px solid #FFCCC7;
            color: #CF1322;
        }

        .alert-warning {
            background: #FFFBE6;
            border: 1px solid #FFE58F;
            color: #D48806;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--light-gray);
            border-top-color: var(--gold-accent);
            border-radius: 50%;
            animation: elegantSpin 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        /* Animations */
        @keyframes elegantSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes cardEnter {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Merchant Edit Form */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 400;
            margin-bottom: 10px;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--dark-gray);
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--light-gray);
            font-family: 'Noto Serif SC', serif;
            font-size: 14px;
            background: var(--pure-white);
            color: var(--secondary-black);
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 3px rgba(200, 169, 108, 0.08);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .store-list {
            max-height: 240px;
            overflow-y: auto;
            border: 1px solid var(--light-gray);
            background: var(--pure-white);
        }

        .store-list::-webkit-scrollbar {
            width: 6px;
        }

        .store-list::-webkit-scrollbar-track {
            background: var(--off-white);
        }

        .store-list::-webkit-scrollbar-thumb {
            background: var(--light-gray);
            border-radius: 3px;
        }

        .store-list::-webkit-scrollbar-thumb:hover {
            background: var(--medium-gray);
        }

        .store-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }

        .store-item:hover {
            background: var(--off-white);
        }

        .store-item:last-child {
            border-bottom: none;
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        /* Modal Content */
        .modal-content {
            background: var(--pure-white);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
            }

            .header-title {
                font-size: 32px;
            }

            .card-body {
                padding: 24px;
            }

            .upload-area {
                padding: 40px 24px;
            }

            .function-select {
                min-width: 100%;
            }

            .btn {
                width: 100%;
                margin-bottom: 12px;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                font-size: 28px;
            }

            .card-body {
                padding: 20px;
            }

            .upload-area {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">COLMO æ•°æ®å¤„ç†å·¥å…·</div>
            <div class="header-subtitle">ä¼å¾®ç”¨æˆ·æ•°æ®æ˜ å°„ä¸å•†æˆ·æ‹†åˆ†</div>
        </div>

        <!-- Function Selector -->
        <div class="function-selector">
            <div class="selector-label">é€‰æ‹©åŠŸèƒ½</div>
            <div class="function-select-wrapper">
                <select class="function-select" id="functionSelect">
                    <option value="mapping">æ ‡ç­¾æ˜ å°„åˆ†ç±»</option>
                    <option value="split">å•†æˆ·æ‹†åˆ†</option>
                </select>
            </div>
        </div>

        <!-- Function 1: Tag Mapping -->
        <div id="mappingFunction">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">æ ‡ç­¾æ˜ å°„åˆ†ç±»</div>
                </div>
                <div class="card-body">
                    <!-- Upload Section -->
                    <div id="mappingUploadSection">
                        <div class="upload-area" id="sourceFileArea">
                            <div class="upload-icon">âŒ¬</div>
                            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æºæ•°æ®æ–‡ä»¶</div>
                            <div class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</div>
                            <input type="file" class="file-input" id="sourceFileInput" accept=".xlsx,.xls">
                        </div>

                        <div class="upload-area" id="targetFileArea">
                            <div class="upload-icon">âŠ•</div>
                            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ç›®æ ‡æ¨¡æ¿æ–‡ä»¶</div>
                            <div class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼ï¼ˆå¯é€‰ï¼‰</div>
                            <input type="file" class="file-input" id="targetFileInput" accept=".xlsx,.xls">
                        </div>
                    </div>

                    <!-- Config Section -->
                    <div class="config-section">
                        <div class="config-header">
                            <div class="config-title">æ˜ å°„è§„åˆ™é…ç½®</div>
                            <div class="config-actions">
                                <button class="btn btn-secondary" onclick="exportMappingRules()">å¯¼å‡ºè§„åˆ™</button>
                                <button class="btn btn-secondary" onclick="importMappingRules()">å¯¼å…¥è§„åˆ™</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="showMappingRulesModal()">æŸ¥çœ‹/ç¼–è¾‘è§„åˆ™</button>
                    </div>

                    <!-- Process Button -->
                    <button class="btn btn-primary" id="mappingProcessBtn" onclick="processMapping()" style="width: 100%; margin-top: 16px;" disabled>
                        ğŸš€ å¼€å§‹å¤„ç†
                    </button>

                    <!-- Progress -->
                    <div class="progress-container" id="mappingProgress">
                        <div class="progress-label">
                            <span>å¤„ç†ä¸­...</span>
                            <span id="mappingProgressText">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar" id="mappingProgressBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="results" id="mappingResults">
                        <div class="results-summary" id="mappingSummary">
                            <!-- Results will be displayed here -->
                        </div>
                        <button class="btn btn-success" onclick="downloadMappingResult()">ğŸ’¾ ä¸‹è½½ç»“æœæ–‡ä»¶</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Function 2: Merchant Split -->
        <div id="splitFunction" class="hidden">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">å•†æˆ·æ‹†åˆ†</div>
                </div>
                <div class="card-body">
                    <!-- Upload Section -->
                    <div id="splitUploadSection">
                        <div class="upload-area" id="splitFileArea">
                            <div class="upload-icon">âŒ¬</div>
                            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ ‡ç­¾æ˜ å°„ç»“æœæ–‡ä»¶</div>
                            <div class="upload-hint">è¯·å…ˆå®Œæˆ"æ ‡ç­¾æ˜ å°„åˆ†ç±»"ï¼Œç„¶åä¸Šä¼ æ˜ å°„åçš„æ–‡ä»¶</div>
                            <input type="file" class="file-input" id="splitFileInput" accept=".xlsx,.xls">
                        </div>
                    </div>

                    <!-- Config Section -->
                    <div class="config-section">
                        <div class="config-header">
                            <div class="config-title">å•†æˆ·é…ç½®</div>
                            <div class="config-actions">
                                <button class="btn btn-secondary" onclick="exportMerchantConfig()">å¯¼å‡ºé…ç½®</button>
                                <button class="btn btn-secondary" onclick="importMerchantConfig()">å¯¼å…¥é…ç½®</button>
                                <button class="btn btn-primary" onclick="showAddMerchantModal()">+ æ·»åŠ å•†æˆ·</button>
                            </div>
                        </div>
                        <div class="merchant-list" id="merchantList">
                            <!-- Merchants will be displayed here -->
                        </div>
                    </div>

                    <!-- Process Button -->
                    <button class="btn btn-primary" id="splitProcessBtn" onclick="processSplit()" style="width: 100%; margin-top: 16px;" disabled>
                        ğŸš€ å¼€å§‹æ‹†åˆ†
                    </button>

                    <!-- Progress -->
                    <div class="progress-container" id="splitProgress">
                        <div class="progress-label">
                            <span>å¤„ç†ä¸­...</span>
                            <span id="splitProgressText">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar" id="splitProgressBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="results" id="splitResults">
                        <div class="results-summary" id="splitSummary">
                            <!-- Results will be displayed here -->
                        </div>
                        <button class="btn btn-success" onclick="downloadSplitResult()">ğŸ“¦ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰æ–‡ä»¶</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapping Rules Modal -->
    <div class="modal" id="mappingRulesModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ˜ å°„è§„åˆ™é…ç½®</div>
                <div class="modal-close" onclick="closeModal('mappingRulesModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div id="mappingRulesContent">
                    <!-- Rules will be displayed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('mappingRulesModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveMappingRules()">ä¿å­˜è§„åˆ™</button>
            </div>
        </div>
    </div>

    <!-- Merchant Edit Modal -->
    <div class="modal" id="merchantModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="merchantModalTitle">æ·»åŠ å•†æˆ·</div>
                <div class="modal-close" onclick="closeModal('merchantModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">å•†æˆ·åç§°</label>
                    <input type="text" class="form-input" id="merchantNameInput" placeholder="è¯·è¾“å…¥å•†æˆ·åç§°">
                </div>
                <div class="form-group">
                    <label class="form-label">æ‰€å±é—¨åº—</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <input type="text" class="form-input" id="storeInput" placeholder="è¾“å…¥é—¨åº—åç§°" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="addStore()">æ·»åŠ </button>
                    </div>
                    <div class="store-list" id="storeList">
                        <!-- Stores will be displayed here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('merchantModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveMerchant()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== é…ç½®æ•°æ® ====================

        // é»˜è®¤æ˜ å°„è§„åˆ™ï¼ˆä»tag_mapper.pyè½¬æ¢ï¼‰
        const DEFAULT_MAPPING_RULES = {
            "æ€§åˆ«": {
                "ç”·": "ç”·",
                "å¥³": "å¥³"
            },
            "å¹´é¾„æ®µ": {
                "25å²ä»¥å†…": "25å²ä»¥å†…",
                "26-35å²": "26-35å²",
                "36-45å²": "36-45å²",
                "46-55å²": "46-55å²",
                "55å²ä»¥ä¸Š": "55å²ä»¥ä¸Š"
            },
            "é¢„ç®—ä»·æ ¼": {
                "0-2W": "0-2W",
                "2W-3W": "2W-3W",
                "3W-6W": "3W-6W",
                "6W-10W": "6W-10W",
                "10W-15W": "10W-15W",
                "15Wä»¥ä¸Š": "15Wä»¥ä¸Š"
            },
            "ç´¯è®¡æ¶ˆè´¹é‡‘é¢": {
                "5000ä»¥å†…": "5000ä»¥å†…",
                "5000ä»¥ä¸‹": "5000ä»¥å†…",
                "5000-10000": "5000-1ä¸‡",
                "6000-10000": "5000-1ä¸‡",
                "10000ä»¥ä¸Š": "1ä¸‡ä»¥ä¸Š",
                "5åƒ-2ä¸‡": "5åƒ-2ä¸‡",
                "0-2ä¸‡": "0-2ä¸‡",
                "2ä¸‡-3ä¸‡": "2ä¸‡-3ä¸‡",
                "3ä¸‡-6ä¸‡": "3ä¸‡-6ä¸‡",
                "6ä¸‡-10ä¸‡": "6ä¸‡-10ä¸‡",
                "10ä¸‡-15ä¸‡": "10ä¸‡-15ä¸‡",
                "15ä¸‡ä»¥ä¸Š": "15ä¸‡ä»¥ä¸Š",
                "1000-3000": "1000-3000"
            },
            "è´­ä¹°éœ€æ±‚": {
                "æ–°æˆ¿è£…ä¿®": "æ–°æˆ¿è£…ä¿®",
                "è€æˆ¿æ”¹é€ ": "è€æˆ¿æ”¹é€ ",
                "å®¶ç”µæ¢æ–°": "å®¶ç”µæ¢æ–°",
                "è´­ç½®æ–°å“ç±»": "è´­ç½®æ–°å“ç±»",
                "æ›¿ä»–äººé€‰è´­": "æ›¿ä»–äººé€‰è´­",
                "éšä¾¿çœ‹çœ‹": "éšä¾¿çœ‹çœ‹"
            },
            "æ„å‘å“ç±»": {
                "ä¸­å¤®ç©ºè°ƒ": "ä¸­å¤®ç©ºè°ƒ",
                "å®¶ç”¨ç©ºè°ƒï¼ˆæŸœæŒ‚æœºï¼‰": "å®¶ç”¨ç©ºè°ƒï¼ˆæŸœæŒ‚æœºï¼‰",
                "å®¶ç”¨ç©ºè°ƒ": "å®¶ç”¨ç©ºè°ƒ",
                "ç©ºè°ƒ": "ç©ºè°ƒ",
                "å†°ç®±": "å†°ç®±",
                "æ´—çƒ˜å¥—": "æ´—çƒ˜å¥—",
                "æ´—è¡£æœº": "æ´—è¡£æœº",
                "æ´—ç¢—æœº": "æ´—ç¢—æœº",
                "çƒŸç¶": "çƒŸç¶",
                "å‡€é¥®æ°´": "å‡€é¥®æ°´",
                "çƒ­æ°´": "çƒ­æ°´",
                "çƒ­æ°´å™¨": "çƒ­æ°´",
                "ç”µçƒ­æ°´å™¨": "çƒ­æ°´",
                "å…¨å±‹æ™ºèƒ½": "å…¨å±‹æ™ºèƒ½",
                "åµŒå…¥å¼": "åµŒå…¥å¼",
                "å£æŒ‚ç‚‰": "å£æŒ‚ç‚‰",
                "å°å®¶ç”µ": "å°å®¶ç”µ",
                "æ–°è±¡å¥—ç³»": "æ–°è±¡å¥—ç³»"
            },
            "å·²è´­å“ç±»": {
                "ä¸­å¤®ç©ºè°ƒï¼ˆå·²ä¹°ï¼‰": "ä¸­å¤®ç©ºè°ƒï¼ˆå·²ä¹°ï¼‰",
                "å®¶ç”¨ç©ºè°ƒï¼ˆæŸœæŒ‚æœºï¼‰ï¼ˆå·²ä¹°ï¼‰": "å®¶ç”¨ç©ºè°ƒï¼ˆæŸœæŒ‚æœºï¼‰ï¼ˆå·²ä¹°ï¼‰",
                "å†°ç®±ï¼ˆå·²ä¹°ï¼‰": "å†°ç®±ï¼ˆå·²ä¹°ï¼‰",
                "æ´—çƒ˜å¥—ï¼ˆå·²ä¹°ï¼‰": "æ´—çƒ˜å¥—ï¼ˆå·²ä¹°ï¼‰",
                "çƒŸç¶ï¼ˆå·²ä¹°ï¼‰": "çƒŸç¶ï¼ˆå·²ä¹°ï¼‰",
                "å‡€æ°´ï¼ˆå·²ä¹°ï¼‰": "å‡€æ°´ï¼ˆå·²ä¹°ï¼‰",
                "çƒ­æ°´ï¼ˆå·²ä¹°ï¼‰": "çƒ­æ°´ï¼ˆå·²ä¹°ï¼‰",
                "åµŒå…¥å¼ï¼ˆå·²ä¹°ï¼‰": "åµŒå…¥å¼ï¼ˆå·²ä¹°ï¼‰",
                "å°å®¶ç”µï¼ˆå·²ä¹°ï¼‰": "å°å®¶ç”µï¼ˆå·²ä¹°ï¼‰",
                "å…¨å±‹æ™ºèƒ½ï¼ˆå·²ä¹°ï¼‰": "å…¨å±‹æ™ºèƒ½ï¼ˆå·²ä¹°ï¼‰",
                "æ–°è±¡å¥—ç³»ï¼ˆå·²ä¹°ï¼‰": "æ–°è±¡å¥—ç³»ï¼ˆå·²ä¹°ï¼‰",
                "å·²è´­-ç”µé£æ‰‡": "å°å®¶ç”µï¼ˆå·²ä¹°ï¼‰",
                "å·²è´­-ç”µé¥­ç…²": "å°å®¶ç”µï¼ˆå·²ä¹°ï¼‰"
            },
            "å®¢æˆ·ç±»å‹": {
                "æ½œåœ¨å®¢æˆ·": "æ½œåœ¨å®¢æˆ·",
                "å·²æˆäº¤": "å·²æˆäº¤",
                "æ¶ˆè´¹è€…": "æ¶ˆè´¹è€…",
                "å†…éƒ¨äººå‘˜": "å†…éƒ¨äººå‘˜",
                "å¼‚ä¸šä¼™ä¼´": "å¼‚ä¸šä¼™ä¼´",
                "æ½œåœ¨å¤§å®¢æˆ·ï¼ˆå¥—è´­ï¼‰": "æ½œåœ¨å¤§å®¢æˆ·ï¼ˆå¥—è´­ï¼‰",
                "è®¾è®¡å¸ˆ": "è®¾è®¡å¸ˆ",
                "å°åŒºç‰©ä¸šäººå‘˜": "å°åŒºç‰©ä¸šäººå‘˜"
            },
            "æ‰€å¤„é˜¶æ®µ": {
                "æ½œåœ¨å®¢æˆ·": "æ½œåœ¨å®¢æˆ·",
                "å·²æˆäº¤": "å·²æˆäº¤",
                "å¤è´­": "å¤è´­",
                "å¤šæ¬¡åˆ°è®¿": "å·²ä»˜å®šé‡‘",
                "äºŒæ¬¡åˆ°è®¿": "å·²ä»˜å®šé‡‘",
                "å·²è¿›ç§è‰ç¾¤": "å·²ä»˜å®šé‡‘",
                "å·²ä»˜å®šé‡‘": "å·²ä»˜å®šé‡‘",
                "å…³å•ï¼ˆæ— è·Ÿè¿›ä»·å€¼ï¼‰": "å…³å•ï¼ˆæ— è·Ÿè¿›ä»·å€¼ï¼‰"
            },
            "æ¥æºæ¸ é“": {
                "è‡ªç„¶è¿›åº—": "è‡ªç„¶è¿›åº—",
                "è€ç”¨æˆ·æ¨è": "è€ç”¨æˆ·æ¨è",
                "è€ç”¨æˆ·å¤è´­": "è€ç”¨æˆ·å¤è´­",
                "è®¾è®¡å¸ˆæ¨è": "è®¾è®¡å¸ˆæ¨è",
                "å¼‚ä¸šæ¨è": "å¼‚ä¸šæ¨è",
                "çº¿ä¸Š": "å…¶ä»–",
                "çº¿ä¸Šå’¨è¯¢": "å…¶ä»–",
                "çº¿ä¸‹": "åœˆå±‚æ´»åŠ¨",
                "çº¿ä¸‹æ´»åŠ¨": "åœˆå±‚æ´»åŠ¨",
                "çº¿ä¸‹é—¨åº—": "å…¶ä»–",
                "æŠ–éŸ³å¼•æµ": "æŠ–éŸ³å¼•æµ",
                "é¦–æ¬¡åˆ°åº—": "è‡ªç„¶è¿›åº—",
                "äºŒæ¬¡åˆ°è®¿": "è‡ªç„¶è¿›åº—",
                "å¤šæ¬¡åˆ°è®¿": "è‡ªç„¶è¿›åº—",
                "å°åŒºæ¨å¹¿": "å°åŒºæ¨å¹¿",
                "å°çº¢ä¹¦å¼•æµ": "å°çº¢ä¹¦å¼•æµ",
                "åœˆå±‚æ´»åŠ¨": "åœˆå±‚æ´»åŠ¨"
            },
            "èŒä¸š": {
                "å®¶åº­ä¸»å¦‡": "å®¶åº­ä¸»å¦‡",
                "åˆ›ä¸šè€…": "åˆ›ä¸šè€…",
                "è‡ªç”±èŒä¸šè€…": "è‡ªç”±èŒä¸šè€…",
                "å†…éƒ¨äººå‘˜": "å†…éƒ¨äººå‘˜",
                "å¼‚ä¸šä¼™ä¼´": "å¼‚ä¸šä¼™ä¼´",
                "å°åŒºç‰©ä¸šäººå‘˜": "å…¶ä»–èŒä¸š",
                "ç™½é¢†": "ç™½é¢†",
                "å…¶ä»–": "å…¶ä»–èŒä¸š",
                "è®¾è®¡å¸ˆ": "ç™½é¢†",
                "ä½“åˆ¶å†…": "ä½“åˆ¶å†…",
                "è‡ªåª’ä½“åšä¸»": "è‡ªåª’ä½“åšä¸»"
            },
            "æˆ¿äº§ç±»å‹": {
                "å•†å“æˆ¿": "å•†å“æˆ¿",
                "åˆ«å¢…ï¼ˆç‹¬æ ‹ï¼‰": "åˆ«å¢…ï¼ˆç‹¬æ ‹ï¼‰",
                "è‡ªå»ºæˆ¿": "è‡ªå»ºæˆ¿",
                "å¤§å¹³å±‚": "å¤§å¹³å±‚",
                "æ´‹æˆ¿": "æ´‹æˆ¿",
                "åˆ«å¢…ï¼ˆå æ‹¼/è”æ’ï¼‰": "åˆ«å¢…ï¼ˆå æ‹¼/è”æ’ï¼‰",
                "å…¶ä»–": "å…¶ä»–æˆ¿äº§ç±»å‹"
            },
            "æˆ¿å±‹é¢ç§¯": {
                "100-150å¹³": "100-150å¹³",
                "150-200å¹³": "150-200å¹³",
                "200-300å¹³": "200-300å¹³",
                "300å¹³ä»¥ä¸Š": "300å¹³ä»¥ä¸Š",
                "100å¹³ä»¥å†…": "100å¹³ä»¥å†…",
                "100-150ã¡": "100-150å¹³"
            },
            "å®¶åº­æƒ…å†µ": {
                "ä¸¤å£ä¹‹å®¶": "ä¸¤å£ä¹‹å®¶",
                "ä¸‰ä»£åŒå ‚": "ä¸‰ä»£åŒå ‚",
                "å¤šå£ä¹‹å®¶": "å¤šå£ä¹‹å®¶",
                "å•èº«": "å•èº«",
                "å•èº«/æœªå©š": "å•èº«",
                "å·²å©šæœ‰å­©": "å¤šå£ä¹‹å®¶",
                "äºŒäººä¸–ç•Œ": "ä¸¤å£ä¹‹å®¶",
                "å®å¦ˆ": "å¤šå£ä¹‹å®¶"
            },
            "åˆ°è®¿æƒ…å†µ": {
                "é¦–æ¬¡åˆ°åº—": "é¦–æ¬¡åˆ°åº—",
                "äºŒæ¬¡åˆ°è®¿": "äºŒæ¬¡åˆ°è®¿",
                "å¤šæ¬¡åˆ°è®¿": "å¤šæ¬¡åˆ°è®¿"
            },
            "æ˜¯å¦COLMOä¼šå‘˜": {
                "æ˜¯": "æ˜¯",
                "å¦": "å¦"
            },
            "è€å¸¦æ–°ç”¨æˆ·æ•°": {
                "1äºº": "1äºº",
                "2-5äºº": "2-5äºº",
                "6-10äºº": "6-10äºº",
                "10äºº+": "10äºº+"
            },
            "è€å¸¦æ–°æˆäº¤æ•°": {
                "1å•": "1å•",
                "2-5å•": "2-5å•",
                "6-10å•": "6-10å•",
                "10å•+": "10å•+"
            },
            "çº¿ä¸‹æ´»åŠ¨": {
                "åŸå¸‚é¦–å‘": "åŸå¸‚é¦–å‘",
                "åœˆå±‚æ´»åŠ¨": "åœˆå±‚æ´»åŠ¨",
                "è€ç”¨æˆ·æ´»åŠ¨": "è€ç”¨æˆ·æ´»åŠ¨",
                "è®¾è®¡å¸ˆåœˆå±‚æ´»åŠ¨": "è®¾è®¡å¸ˆåœˆå±‚æ´»åŠ¨",
                "å°åŒºå¤–æ‹“æ´»åŠ¨": "å°åŒºå¤–æ‹“æ´»åŠ¨",
                "æ ·æ¿é—´è¿›é©»": "æ ·æ¿é—´è¿›é©»",
                "å®¶åšä¼š": "å®¶åšä¼š",
                "è£…ä¼ä¸»æ¨": "è£…ä¼ä¸»æ¨"
            }
        };

        // ç™½åå•
        const FIELD_WHITELIST = {
            "æ€§åˆ«": ["ç”·", "å¥³"],
            "å®¢æˆ·ç±»å‹": ["å°åŒºç‰©ä¸šäººå‘˜", "å¼‚ä¸šä¼™ä¼´", "è®¾è®¡å¸ˆ", "æ¶ˆè´¹è€…", "å†…éƒ¨äººå‘˜"],
            "æ‰€å¤„é˜¶æ®µ": ["å¤è´­", "å·²æˆäº¤", "å·²ä»˜å®šé‡‘", "æ½œåœ¨å¤§å®¢æˆ·ï¼ˆå¥—è´­ï¼‰", "æ½œåœ¨å®¢æˆ·", "å…³å•ï¼ˆæ— è·Ÿè¿›ä»·å€¼ï¼‰"],
            "è´­ä¹°éœ€æ±‚": ["è´­ç½®æ–°å“ç±»", "æ–°æˆ¿è£…ä¿®", "è€æˆ¿æ”¹é€ ", "å®¶ç”µæ¢æ–°", "æ›¿ä»–äººé€‰è´­", "éšä¾¿çœ‹çœ‹"],
            "å¹´é¾„æ®µ": ["25å²ä»¥å†…", "26-35å²", "36-45å²", "46-55å²", "55å²ä»¥ä¸Š"],
            "èŒä¸š": ["å®¶åº­ä¸»å¦‡", "ä½“åˆ¶å†…", "åˆ›ä¸šè€…", "å…¶ä»–èŒä¸š", "è‡ªç”±èŒä¸šè€…", "è‡ªåª’ä½“åšä¸»", "ç™½é¢†"],
            "æˆ¿äº§ç±»å‹": ["å…¶ä»–æˆ¿äº§ç±»å‹", "è‡ªå»ºæˆ¿", "å•†å“æˆ¿", "å¤§å¹³å±‚", "æ´‹æˆ¿", "åˆ«å¢…ï¼ˆç‹¬æ ‹ï¼‰", "åˆ«å¢…ï¼ˆå æ‹¼/è”æ’ï¼‰"],
            "æˆ¿å±‹é¢ç§¯": ["100å¹³ä»¥å†…", "100-150å¹³", "150-200å¹³", "200-300å¹³", "300å¹³ä»¥ä¸Š"],
            "å®¶åº­æƒ…å†µ": ["ä¸‰ä»£åŒå ‚", "å¤šå£ä¹‹å®¶", "ä¸¤å£ä¹‹å®¶", "å•èº«"],
            "åˆ°è®¿æƒ…å†µ": ["é¦–æ¬¡åˆ°åº—", "äºŒæ¬¡åˆ°è®¿", "å¤šæ¬¡åˆ°è®¿", "æœªåˆ°åº—"],
            "æ¥æºæ¸ é“": ["è‡ªç„¶è¿›åº—", "è®¾è®¡å¸ˆæ¨è", "å¼‚ä¸šæ¨è", "è€ç”¨æˆ·æ¨è", "è€ç”¨æˆ·å¤è´­", "åœˆå±‚æ´»åŠ¨", "å°çº¢ä¹¦å¼•æµ", "æŠ–éŸ³å¼•æµ", "ç¾å›¢é«˜å¾·", "å°åŒºæ¨å¹¿", "å…¶ä»–"],
            "é¢„ç®—ä»·æ ¼": ["0-2W", "2W-3W", "3W-6W", "6W-10W", "10W-15W", "15Wä»¥ä¸Š"],
            "ç´¯è®¡æ¶ˆè´¹é‡‘é¢": ["5000ä»¥å†…", "5000-1ä¸‡", "1ä¸‡ä»¥ä¸Š", "5åƒ-2ä¸‡", "0-2ä¸‡", "2ä¸‡-3ä¸‡", "3ä¸‡-6ä¸‡", "6ä¸‡-10ä¸‡", "10ä¸‡-15ä¸‡", "15ä¸‡ä»¥ä¸Š", "1000-3000"],
            "æ„å‘å“ç±»": ["å£æŒ‚ç‚‰", "å®¶ç”¨ç©ºè°ƒï¼ˆæŸœæŒ‚æœºï¼‰", "ä¸­å¤®ç©ºè°ƒ", "å†°ç®±", "æ´—çƒ˜å¥—", "çƒŸç¶", "æ´—ç¢—æœº", "å‡€é¥®æ°´", "çƒ­æ°´", "åµŒå…¥å¼", "å°å®¶ç”µ", "å…¨å±‹æ™ºèƒ½", "æ–°è±¡å¥—ç³»"],
            "å·²è´­å“ç±»": ["å®¶ç”¨ç©ºè°ƒï¼ˆæŸœæŒ‚æœºï¼‰ï¼ˆå·²ä¹°ï¼‰", "ä¸­å¤®ç©ºè°ƒï¼ˆå·²ä¹°ï¼‰", "å†°ç®±ï¼ˆå·²ä¹°ï¼‰", "æ´—çƒ˜å¥—ï¼ˆå·²ä¹°ï¼‰", "çƒŸç¶ï¼ˆå·²ä¹°ï¼‰", "å‡€æ°´ï¼ˆå·²ä¹°ï¼‰", "çƒ­æ°´ï¼ˆå·²ä¹°ï¼‰", "åµŒå…¥å¼ï¼ˆå·²ä¹°ï¼‰", "å°å®¶ç”µï¼ˆå·²ä¹°ï¼‰", "å…¨å±‹æ™ºèƒ½ï¼ˆå·²ä¹°ï¼‰", "æ–°è±¡å¥—ç³»ï¼ˆå·²ä¹°ï¼‰"],
            "æ˜¯å¦COLMOä¼šå‘˜": ["æ˜¯", "å¦"],
            "è€å¸¦æ–°æˆäº¤æ•°": ["1å•", "2-5å•", "6-10å•", "10å•+"],
            "è€å¸¦æ–°ç”¨æˆ·æ•°": ["1äºº", "2-5äºº", "6-10äºº", "10äºº+"],
            "çº¿ä¸‹æ´»åŠ¨": ["åŸå¸‚é¦–å‘", "åœˆå±‚æ´»åŠ¨", "è€ç”¨æˆ·æ´»åŠ¨", "è®¾è®¡å¸ˆåœˆå±‚æ´»åŠ¨", "å°åŒºå¤–æ‹“æ´»åŠ¨", "æ ·æ¿é—´è¿›é©»", "å®¶åšä¼š", "è£…ä¼ä¸»æ¨"]
        };

        // é»˜è®¤å•†æˆ·é…ç½®
        const DEFAULT_MERCHANTS = [
            {
                name: "éƒ‘å·äº¨æ³½",
                stores: [
                    "æ¬§å‡¯é¾™å®¶å±…éƒ‘å·éƒ‘ä¸œæ–°åŒºå•†åœºCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "èŠ±å›­è·¯å¤§æ˜å®«COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "å±…ç„¶ä¹‹å®¶éƒ‘å·ä¸­é™†å•†åœºCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "éƒ‘å·éƒ‘å·èˆªç©ºæ¸¯ç»æµç»¼åˆå®éªŒåŒºæ¸´æ…•COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "å±…ç„¶ä¹‹å®¶éƒ‘å·å•†éƒ½è·¯å•†åœºCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "ä¸Šè¡—åŒºæ¬§å‡¯é¾™COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "å•†éƒ½è·¯çº¢æ˜ŸCOLMOåŸå¸‚ä½“éªŒä¸­å¿ƒ",
                    "å·©ä¹‰ä¸‡æ´‹å•†è´¸åŸCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "ç™»å°å›½é™…å•†è´¸åŸCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "åŒ—é¾™æ¹–å±…ç„¶COLMOåŸå¸‚ä½“éªŒä¸­å¿ƒ",
                    "ä¸‰é—¨å³¡ä¹‰ä¹Œå›½é™…å•†è´¸åŸCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "éƒ‘å·é‡‘æ°´åŒºå‡¤å‡°åŸCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "é«˜æ–°ä¸‡è¾¾COLMOæ™ºæ„Ÿä½“éªŒé¦†ï¼ˆMallï¼‰",
                    "éƒ‘å·ä¸­ç‰Ÿå¿ç§‘æ³½COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æ¬§å‡¯é¾™å®¶å±…éƒ‘å·åµ©å±±è·¯å•†åœºCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æ¬§å‡¯é¾™å®¶å±…éƒ‘å·ä¸­åŸè·¯å•†åœºCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "èŠ±å›­è·¯ä¸¹å°¼æ–¯COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "éƒ‘å·éƒ‘å·é«˜æ–°æŠ€æœ¯äº§ä¸šå¼€å‘åŒºç‘è¾¾è·¯COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "é«˜æ–°ä¸‡è¾¾COLMOæ™ºæ„Ÿä½“éªŒé¦†"
                ]
            },
            {
                name: "é•¿æ²™éº“æ˜",
                stores: [
                    "é•¿æ²™åœ­å¡˜è¡—é“æ¹–å—åæ€¡COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "å²³éº“åŒºå¹¿å¤§ç¯çƒCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "é•¿æ²™æ–¹åœ†èŸè¶…çº§COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "é›¨èŠ±åŒºæ¬§äºšè¾¾COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "é•¿æ²™æœ›åŸå¾æ‚¦COLMOæ™ºæ„Ÿä½“éªŒé¦†ï¼ˆMallï¼‰",
                    "æœ›åŸåŒºæ¹¾ç”°å›½é™…COLMOæ™ºæ„Ÿä½“éªŒé¦†"
                ]
            },
            {
                name: "å±±ä¸œç¾æ£®",
                stores: [
                    "é‡‘ä¹¡çº¢æ˜Ÿç¾å‡¯é¾™COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "é‚¹åŸæ–°éƒ½æ±‡COLMOä½“éªŒé¦†",
                    "æµå®ä¸‡è±¡æ±‡COLMOä½“éªŒé¦†",
                    "å±±ä¸œç¾æ£®èˆ’é€‚å®¶COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "å˜‰ç¥¥COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "é±¼å°å¿COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "é‚¹åŸçº¢æ˜Ÿç¾å‡¯é¾™COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æµå®é‡‘å®‡COLMOæ™ºæ„Ÿä½“éªŒé¦†"
                ]
            },
            {
                name: "å¤©æ´¥é˜¿ç¾ä¹",
                stores: [
                    "å”å±±å±…ç„¶ä¹‹å®¶å›ç‘COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "ç§¦çš‡å²›æ˜Œé»å¿é˜¿ç¾ä¹COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "çº¢æ˜Ÿç¾å‡¯é¾™å”å±±æ—¶ä»£å®¶å±…COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "ç§¦çš‡å²›æµ·æ¸¯åŒºå¸…æ³°æ‚ äº«ç¾å­¦å¤§å®¶å±…COLMOæ™ºæ„Ÿä½“éªŒé¦†"
                ]
            },
            {
                name: "å±±ä¸œè‰¾å¾·æº",
                stores: [
                    "çº¢æ˜Ÿç¾å‡¯é¾™æµå—åŒ—å›­å¤§è¡—å•†åœºCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æµå—å¤©æ¡¥é“¶åº§ä¸­å¿ƒåº—COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æµå—å¸‚æ—…æ¸¸è·¯çº¢æ˜Ÿç¾å‡¯é¾™COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "é»„å°ç¯çƒå®¶å±…COLMOåŸå¸‚ä½“éªŒä¸­å¿ƒ",
                    "åŒ—å®¸é¾™æ¹–COLMOæ™ºæ„Ÿä½“éªŒé¦†ï¼ˆMallï¼‰",
                    "æµå—è¥¿åŸé¾™æ¹–COLMOæ™ºæ„Ÿä½“éªŒé¦†"
                ]
            },
            {
                name: "å—æ˜Œç†äº«",
                stores: [
                    "å—æ˜Œäº¬ä¸œé•‡æ±Ÿè¥¿å¹¿ç”µCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "å—æ˜ŒåŸä¸œé¦™æ±ŸCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "å—æ˜Œåçš“COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "å—æ˜Œä¸‡è±¡åŸCOLMOæ™ºæ„Ÿä½“éªŒé¦†ï¼ˆMallï¼‰",
                    "å—æ˜Œé’äº‘è°±åŒºå¹¿å·è·¯COLMOæ™ºæ„Ÿä½“éªŒé¦†"
                ]
            },
            {
                name: "æ¸©å·ä¸­èˆª",
                stores: [
                    "é¾™æ¸¯æ–°é¸¿æœªæ¥åŸCOLMOæ™ºæ„Ÿä½“éªŒé¦†ï¼ˆMallï¼‰",
                    "ç“¯æµ·ç¬¬å…­ç©ºé—´COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "ç‘å®‰å¾æ‚¦å¹¿åœºCOLMOæ™ºæ„Ÿä½“éªŒé¦†ï¼ˆMallï¼‰",
                    "æ¸©å·è”ç»“ç¦å»ºæCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æ¸©å·é¾™æ¹¾å¾æ‚¦COLMOä½“éªŒåº—",
                    "æ¸©å·ç“¯æµ·COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æ¸©å·å¹³é˜³é¸¿å°é‡ŒCOLMOæ™ºæ„Ÿä½“éªŒé¦†"
                ]
            },
            {
                name: "å¸¸å·çºµè´¯çº¿",
                stores: [
                    "å¸¸å·æ–°åŒ—æœˆæ˜Ÿå®¶å±…COLMOæ™ºæ„Ÿä½“éªŒé¦†ï¼ˆMallï¼‰",
                    "å¸¸å·é£é¾™çº¢æ˜Ÿç¾å‡¯é¾™COLMOæ™ºæ„Ÿä½“éªŒé¦†"
                ]
            },
            {
                name: "æ±Ÿè‹å‚²æ¾",
                stores: [
                    "çº¢æ˜Ÿç¾å‡¯é¾™è‹å·å›­åŒº1å·åº—COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "å´æ±Ÿå±…ç„¶ä¹‹å®¶COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æ¡æ³¾åŒ—è·¯æœˆæ˜Ÿå®¶å±…COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "çº¢æ˜Ÿç¾å‡¯é¾™è‹å·è ¡å£å•†åœºCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "çº¢æ˜Ÿç¾å‡¯é¾™è‹å·å´ä¸­ä¸œæ–¹å•†åœºCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "é¾™æ¹–ç‹®å±±å¤©è¡—COLMOæ™ºæ„Ÿä½“éªŒé¦†"
                ]
            },
            {
                name: "è‹å·èé¼",
                stores: [
                    "è‹å·æ–°åŒºæ°¸æ—ºCOLMOæ™ºæ„Ÿä½“éªŒé¦†ï¼ˆMallï¼‰"
                ]
            },
            {
                name: "æ­å·ç§‘æ…•",
                stores: [
                    "æ­å·æ–°æ—¶ä»£COLMOå®¶ä¸­æ™ºæ…§ç©ºæ°”é¦†",
                    "çº¢æ˜Ÿç¾å‡¯é¾™æ­å·è‡³å°ŠMALLå•†åœºCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æ­å·ä¸­åšè£…é¥°COLMOè£…ä¼åº—"
                ]
            },
            {
                name: "æµ™æ±Ÿä¸–ç›æ˜“å®¶",
                stores: [
                    "æ­å·æ±Ÿå—å®¶å±…COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æ­å·è¥¿æŠ•é“¶æ³°COLMOæ™ºæ„Ÿä½“éªŒé¦†ï¼ˆMallï¼‰"
                ]
            },
            {
                name: "æ­å·å›ç§‘",
                stores: [
                    "æ­å·æ’å¤§å›½é™…å»ºæCOLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æ­å·åœ£éƒ½è£…é¥°COLMOæ™ºæ„Ÿä½“éªŒé¦†",
                    "æ­å·é“­å“COLMOå®¶ä¸­ä¸“ä¸šåº—",
                    "æ­å·æ»¨æ±Ÿå…­ç©º8090COLMOåŸå¸‚ä½“éªŒä¸­å¿ƒ"
                ]
            }
        ];

        // ==================== å…¨å±€å˜é‡ ====================

        let mappingRules = JSON.parse(JSON.stringify(DEFAULT_MAPPING_RULES));
        let merchants = JSON.parse(JSON.stringify(DEFAULT_MERCHANTS));
        let sourceFileData = null;
        let targetFileData = null;
        let splitFileData = null;
        let mappingResultData = null;
        let splitResultData = null;
        let currentEditingMerchantIndex = -1;
        let tempStoreList = [];

        // ==================== åˆå§‹åŒ– ====================

        document.addEventListener('DOMContentLoaded', function() {
            initFunctionSelector();
            initUploadAreas();
            initMerchantList();
            loadSavedConfig();
        });

        function initFunctionSelector() {
            const select = document.getElementById('functionSelect');
            select.addEventListener('change', function() {
                const value = this.value;
                document.getElementById('mappingFunction').classList.toggle('hidden', value !== 'mapping');
                document.getElementById('splitFunction').classList.toggle('hidden', value !== 'split');
            });
        }

        function initUploadAreas() {
            // Mapping function upload areas
            setupUploadArea('sourceFileArea', 'sourceFileInput', function(file) {
                sourceFileData = file;
                displayFileInfo('sourceFileArea', file);
                checkMappingReady();
            });

            setupUploadArea('targetFileArea', 'targetFileInput', function(file) {
                targetFileData = file;
                displayFileInfo('targetFileArea', file);
            });

            // Split function upload area
            setupUploadArea('splitFileArea', 'splitFileInput', function(file) {
                splitFileData = file;
                displayFileInfo('splitFileArea', file);
                checkSplitReady();
            });
        }

        function setupUploadArea(areaId, inputId, callback) {
            const area = document.getElementById(areaId);
            const input = document.getElementById(inputId);

            area.addEventListener('click', () => input.click());

            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });

            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });

            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                    callback(file);
                } else {
                    alert('è¯·ä¸Šä¼  Excel æ–‡ä»¶ (.xlsx æˆ– .xls)');
                }
            });

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    callback(file);
                }
            });
        }

        function displayFileInfo(areaId, file) {
            const area = document.getElementById(areaId);
            area.innerHTML = `
                <div class="file-item">
                    <div class="file-icon">ğŸ“„</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="file-remove" onclick="removeFile('${areaId}', '${areaId.replace('Area', 'Input')}')">&times;</div>
                </div>
            `;
        }

        function removeFile(areaId, inputId) {
            document.getElementById(areaId).innerHTML = `
                <div class="upload-icon">ğŸ“„</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶</div>
                <div class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</div>
            `;

            if (areaId === 'sourceFileArea') {
                sourceFileData = null;
            } else if (areaId === 'targetFileArea') {
                targetFileData = null;
            } else if (areaId === 'splitFileArea') {
                splitFileData = null;
            }

            checkMappingReady();
            checkSplitReady();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function checkMappingReady() {
            const btn = document.getElementById('mappingProcessBtn');
            btn.disabled = !sourceFileData;
        }

        function checkSplitReady() {
            const btn = document.getElementById('splitProcessBtn');
            btn.disabled = !splitFileData;
        }

        // ==================== æ ‡ç­¾æ˜ å°„å¼•æ“ ====================

        function parseTags(tagsStr) {
            if (!tagsStr) return {};

            const tags = tagsStr.split(',').map(t => t.trim()).filter(t => t);
            const result = {};

            // å¤šå€¼å­—æ®µ
            const interestCategories = [];
            const purchasedCategories = [];
            const demands = [];

            for (const tag of tags) {
                let matched = false;

                for (const [fieldName, fieldMap] of Object.entries(mappingRules)) {
                    if (tag in fieldMap) {
                        const targetValue = fieldMap[tag];

                        if (fieldName === 'æ„å‘å“ç±»') {
                            interestCategories.push(targetValue);
                        } else if (fieldName === 'å·²è´­å“ç±»') {
                            purchasedCategories.push(targetValue);
                        } else if (fieldName === 'è´­ä¹°éœ€æ±‚') {
                            demands.push(targetValue);
                        } else {
                            result[fieldName] = targetValue;
                        }

                        matched = true;
                        break;
                    }
                }
            }

            // å¤„ç†å¤šå€¼å­—æ®µ
            if (interestCategories.length > 0) {
                result['æ„å‘å“ç±»'] = interestCategories.join(',');
            }
            if (purchasedCategories.length > 0) {
                result['å·²è´­å“ç±»'] = purchasedCategories.join(',');
            }
            if (demands.length > 0) {
                result['è´­ä¹°éœ€æ±‚'] = demands.join(',');
            }

            // ç™½åå•éªŒè¯
            const filteredResult = {};
            for (const [fieldName, fieldValue] of Object.entries(result)) {
                if (FIELD_WHITELIST[fieldName]) {
                    const whitelist = FIELD_WHITELIST[fieldName];

                    if (['æ„å‘å“ç±»', 'å·²è´­å“ç±»', 'è´­ä¹°éœ€æ±‚'].includes(fieldName)) {
                        const values = fieldValue.split(',').map(v => v.trim());
                        const validValues = values.filter(v => whitelist.includes(v));
                        if (validValues.length > 0) {
                            filteredResult[fieldName] = validValues.join(',');
                        }
                    } else {
                        if (whitelist.includes(fieldValue)) {
                            filteredResult[fieldName] = fieldValue;
                        }
                    }
                } else {
                    filteredResult[fieldName] = fieldValue;
                }
            }

            return filteredResult;
        }

        async function processMapping() {
            if (!sourceFileData) return;

            showProgress('mapping');
            const progress = { current: 0, total: 0 };

            try {
                // è¯»å–æºæ–‡ä»¶
                updateProgress('mapping', 10, 'è¯»å–æºæ–‡ä»¶...');
                const sourceWorkbook = await readExcelFile(sourceFileData);
                const sourceSheet = sourceWorkbook.Sheets[sourceWorkbook.SheetNames[0]];
                const sourceData = XLSX.utils.sheet_to_json(sourceSheet, { header: 1 });

                progress.total = sourceData.length;

                // å¤„ç†æ•°æ®
                const mappedData = [];
                const headers = [
                    'å®¢æˆ·åç§°', 'å®¢æˆ·', 'æ·»åŠ äºº', 'æ·»åŠ æ—¶é—´', 'æ¥æº', 'æ·»åŠ äººæ‰€å±éƒ¨é—¨',
                    'æ€§åˆ«', 'å®¢æˆ·ç±»å‹', 'æ¥æºæ¸ é“', 'æ‰€å¤„é˜¶æ®µ', 'è´­ä¹°éœ€æ±‚', 'æ„å‘å“ç±»', 'å·²è´­å“ç±»',
                    'ç´¯è®¡æ¶ˆè´¹é‡‘é¢', 'å¹´é¾„æ®µ', 'èŒä¸š', 'æˆ¿äº§ç±»å‹', 'æˆ¿å±‹é¢ç§¯', 'å®¶åº­æƒ…å†µ',
                    'åˆ°è®¿æƒ…å†µ', 'é¢„ç®—ä»·æ ¼', 'æ˜¯å¦COLMOä¼šå‘˜', 'è€å¸¦æ–°ç”¨æˆ·æ•°', 'è€å¸¦æ–°æˆäº¤æ•°',
                    'çº¿ä¸‹æ´»åŠ¨', 'æ‰€åœ¨å°åŒº', 'æ¨èäººèº«ä»½-å§“å', 'å…³æ³¨ç«å“', 'å…¶ä»–å·²å®šå®¶è£…/å®¶å±…å“ç‰Œ', 'å…³å•åŸå› '
                ];

                for (let i = 0; i < sourceData.length; i++) {
                    const row = sourceData[i];
                    const tagsStr = row[10]; // Kåˆ—ï¼šä¼å¾®æ ‡ç­¾

                    // è§£ææ ‡ç­¾
                    const tagFields = parseTags(tagsStr);

                    // æ„å»ºè¾“å‡ºè¡Œ
                    const outputRow = {
                        'å®¢æˆ·åç§°': row[0] || '',
                        'å®¢æˆ·': row[0] || '',
                        'æ·»åŠ äºº': row[4] || '',
                        'æ·»åŠ æ—¶é—´': row[7] || '',
                        'æ¥æº': row[8] || '',
                        'æ·»åŠ äººæ‰€å±éƒ¨é—¨': row[6] || ''
                    };

                    Object.assign(outputRow, tagFields);

                    mappedData.push(outputRow);

                    progress.current = i + 1;
                    const percent = Math.floor((progress.current / progress.total) * 80) + 10;
                    updateProgress('mapping', percent, `å¤„ç†ä¸­: ${progress.current}/${progress.total}`);

                    // æ¯100æ¡æ›´æ–°ä¸€æ¬¡ï¼Œé¿å…é˜»å¡UI
                    if (i % 100 === 0) {
                        await sleep(1);
                    }
                }

                mappingResultData = { headers, data: mappedData };

                // æ˜¾ç¤ºç»“æœ
                showMappingResults(mappedData);
                updateProgress('mapping', 100, 'âœ… å¤„ç†å®Œæˆ!');

                setTimeout(() => {
                    hideProgress('mapping');
                }, 1000);

            } catch (error) {
                console.error('å¤„ç†å¤±è´¥:', error);
                alert('å¤„ç†å¤±è´¥: ' + error.message);
                hideProgress('mapping');
            }
        }

        function showMappingResults(data) {
            const container = document.getElementById('mappingResults');
            const summary = document.getElementById('mappingSummary');

            // ç»Ÿè®¡å„å­—æ®µçš„æ•°æ®é‡
            const fieldStats = {};
            for (const row of data) {
                for (const [key, value] of Object.entries(row)) {
                    if (value) {
                        if (!fieldStats[key]) fieldStats[key] = 0;
                        fieldStats[key]++;
                    }
                }
            }

            // æ„å»ºç»“æœHTML
            let html = '<div class="result-item"><span class="result-label">æ€»æ•°æ®é‡:</span><span class="result-value">' + data.length + ' æ¡</span></div>';

            for (const [field, count] of Object.entries(fieldStats)) {
                html += '<div class="result-item"><span class="result-label">' + field + ':</span><span class="result-value">' + count + ' æ¡</span></div>';
            }

            summary.innerHTML = html;
            container.style.display = 'block';
        }

        function downloadMappingResult() {
            if (!mappingResultData) return;

            const { headers, data } = mappingResultData;
            const ws = XLSX.utils.json_to_sheet(data, { header: headers });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å¤„ç†ç»“æœ');

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            XLSX.writeFile(wb, `æ ‡ç­¾æ˜ å°„ç»“æœ_${timestamp}.xlsx`);
        }

        // ==================== å•†æˆ·æ‹†åˆ†å¼•æ“ ====================

        function determineMerchant(department) {
            if (!department) return null;

            for (const merchant of merchants) {
                for (const store of merchant.stores) {
                    if (department.includes(store)) {
                        return merchant.name;
                    }
                }
            }

            return null;
        }

        async function processSplit() {
            if (!splitFileData) return;

            showProgress('split');
            const progress = { current: 0, total: 0 };

            try {
                // è¯»å–æºæ–‡ä»¶
                updateProgress('split', 10, 'è¯»å–æºæ–‡ä»¶...');
                const sourceWorkbook = await readExcelFile(splitFileData);
                const sourceSheet = sourceWorkbook.Sheets[sourceWorkbook.SheetNames[0]];
                const sourceData = XLSX.utils.sheet_to_json(sourceSheet, { header: 1 });

                // è‡ªåŠ¨æŸ¥æ‰¾ã€Œæ·»åŠ äººæ‰€å±éƒ¨é—¨ã€åˆ—çš„ç´¢å¼•
                updateProgress('split', 15, 'è¯†åˆ«åˆ—ç»“æ„...');
                let departmentColumnIndex = -1;
                const headerRow = sourceData[0];

                // å°è¯•å¤šç§å¯èƒ½çš„åˆ—å
                const possibleNames = ['æ·»åŠ äººæ‰€å±éƒ¨é—¨', 'æ‰€å±éƒ¨é—¨', 'éƒ¨é—¨', 'æ·»åŠ äººéƒ¨é—¨'];

                for (const name of possibleNames) {
                    const index = headerRow.indexOf(name);
                    if (index !== -1) {
                        departmentColumnIndex = index;
                        console.log(`âœ… æ‰¾åˆ°åˆ—: "${name}" åœ¨ç¬¬ ${index + 1} åˆ—`);
                        break;
                    }
                }

                if (departmentColumnIndex === -1) {
                    throw new Error('æœªæ‰¾åˆ°ã€Œæ·»åŠ äººæ‰€å±éƒ¨é—¨ã€åˆ—ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶è¡¨å¤´\n\nå¯èƒ½çš„åˆ—åï¼šæ·»åŠ äººæ‰€å±éƒ¨é—¨ã€æ‰€å±éƒ¨é—¨ã€éƒ¨é—¨ã€æ·»åŠ äººéƒ¨é—¨');
                }

                progress.total = sourceData.length - 1; // å‡å»è¡¨å¤´è¡Œ

                // æŒ‰å•†æˆ·åˆ†ç±»
                const merchantData = {};
                const unmatchedData = [];

                for (const merchant of merchants) {
                    merchantData[merchant.name] = [];
                }

                // ä»ç¬¬äºŒè¡Œå¼€å§‹å¤„ç†æ•°æ®ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
                for (let i = 1; i < sourceData.length; i++) {
                    const row = sourceData[i];
                    const department = row[departmentColumnIndex]; // ä½¿ç”¨æ‰¾åˆ°çš„åˆ—ç´¢å¼•

                    const merchant = determineMerchant(department);

                    if (merchant) {
                        merchantData[merchant].push(row);
                    } else {
                        unmatchedData.push(row);
                    }

                    progress.current = i;
                    const percent = Math.floor((progress.current / progress.total) * 80) + 15;
                    updateProgress('split', percent, `å¤„ç†ä¸­: ${progress.current}/${progress.total}`);

                    if (i % 100 === 0) {
                        await sleep(1);
                    }
                }

                // æ·»åŠ è¡¨å¤´åˆ°æ‰€æœ‰æ•°æ®
                for (const merchantName in merchantData) {
                    if (merchantData[merchantName].length > 0) {
                        merchantData[merchantName].unshift(headerRow);
                    }
                }
                if (unmatchedData.length > 0) {
                    unmatchedData.unshift(headerRow);
                }

                splitResultData = { merchantData, unmatchedData };

                // æ˜¾ç¤ºç»“æœ
                showSplitResults(merchantData, unmatchedData);
                updateProgress('split', 100, 'âœ… å¤„ç†å®Œæˆ!');

                setTimeout(() => {
                    hideProgress('split');
                }, 1000);

            } catch (error) {
                console.error('æ‹†åˆ†å¤±è´¥:', error);
                alert('æ‹†åˆ†å¤±è´¥: ' + error.message);
                hideProgress('split');
            }
        }

        function showSplitResults(merchantData, unmatchedData) {
            const container = document.getElementById('splitResults');
            const summary = document.getElementById('splitSummary');

            let html = '';

            for (const [merchantName, data] of Object.entries(merchantData)) {
                const count = data.length;
                const hasData = count > 0;
                html += `<div class="result-item" style="color: ${hasData ? 'inherit' : '#999'}">`;
                html += `<span class="result-label">${merchantName}:</span>`;
                html += `<span class="result-value">${count} æ¡</span>`;
                // æ·»åŠ å•ç‹¬ä¸‹è½½æŒ‰é’®
                if (hasData) {
                    html += `<button class="btn-download-single" onclick="downloadSingleMerchant('${merchantName}')" style="margin-left: 10px; padding: 4px 12px; font-size: 13px;">ğŸ“¥ ä¸‹è½½</button>`;
                }
                html += '</div>';
            }

            if (unmatchedData.length > 0) {
                html += '<div class="result-item" style="color: #FAAD14;">';
                html += '<span class="result-label">âš ï¸ æœªåˆ†é…:</span>';
                html += '<span class="result-value">' + unmatchedData.length + ' æ¡</span>';
                // æœªåˆ†é…æ•°æ®ä¹Ÿå¯ä»¥ä¸‹è½½
                html += `<button class="btn-download-single" onclick="downloadUnassigned()" style="margin-left: 10px; padding: 4px 12px; font-size: 13px;">ğŸ“¥ ä¸‹è½½</button>`;
                html += '</div>';
            }

            html += '<div class="result-item">';
            html += '<span class="result-label">æ€»è®¡:</span>';
            html += '<span class="result-value">' + (Object.keys(merchantData).length) + ' ä¸ªå•†æˆ·</span>';
            html += '</div>';

            summary.innerHTML = html;
            summary.className = 'results-summary';
            if (unmatchedData.length > 0) {
                summary.className = 'results-summary warning';
            }

            container.style.display = 'block';
        }

        // å•ç‹¬ä¸‹è½½æŸä¸ªå•†æˆ·çš„æ–‡ä»¶
        async function downloadSingleMerchant(merchantName) {
            if (!splitResultData) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®');
                return;
            }

            try {
                const { merchantData } = splitResultData;
                const data = merchantData[merchantName];

                if (!data || data.length === 0) {
                    alert(`${merchantName} æ²¡æœ‰æ•°æ®`);
                    return;
                }

                // ä½¿ç”¨ aoa_to_sheet å¤„ç†æ•°ç»„æ ¼å¼æ•°æ®
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, merchantName);

                // ä¸‹è½½å•ä¸ªæ–‡ä»¶
                XLSX.writeFile(wb, `${merchantName}.xlsx`);
                console.log(`âœ… å·²ä¸‹è½½: ${merchantName}.xlsx`);
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // ä¸‹è½½æœªåˆ†é…æ•°æ®
        async function downloadUnassigned() {
            if (!splitResultData) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®');
                return;
            }

            try {
                const { unmatchedData } = splitResultData;

                if (!unmatchedData || unmatchedData.length === 0) {
                    alert('æ²¡æœ‰æœªåˆ†é…æ•°æ®');
                    return;
                }

                const ws = XLSX.utils.aoa_to_sheet(unmatchedData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'æœªåˆ†é…');

                XLSX.writeFile(wb, `æœªåˆ†é….xlsx`);
                console.log('âœ… å·²ä¸‹è½½: æœªåˆ†é….xlsx');
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        async function downloadSplitResult() {
            console.log('=== downloadSplitResult è¢«è°ƒç”¨ ===');
            console.log('splitResultData å­˜åœ¨:', !!splitResultData);

            if (!splitResultData) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®ï¼Œè¯·å…ˆè¿›è¡Œå•†æˆ·æ‹†åˆ†');
                return;
            }

            // æ£€æŸ¥å¿…éœ€çš„åº“ï¼ˆCSV æ–¹æ¡ˆä¸éœ€è¦ XLSX.utilsï¼‰
            console.log('=== æ£€æŸ¥åº“æ–‡ä»¶ ===');
            console.log('JSZip:', typeof JSZip);
            console.log('window.JSZip:', typeof window.JSZip);
            console.log('saveAs:', typeof saveAs);

            const JSZipConstructor = window.JSZip || JSZip;
            if (!JSZipConstructor) {
                alert('âŒ JSZip åº“æœªåŠ è½½ï¼\n\nè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                return;
            }

            if (typeof saveAs === 'undefined') {
                alert('âŒ ä¸‹è½½åº“ï¼ˆFileSaverï¼‰æœªåŠ è½½ï¼\n\nè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                return;
            }

            console.log('âœ… å‡†å¤‡æ‰“åŒ…ï¼Œä½¿ç”¨ CSV æ ¼å¼ï¼ˆExcel å¯ç›´æ¥æ‰“å¼€ï¼‰');
            console.log('merchantData:', Object.keys(splitResultData.merchantData));

            // CSV ç”Ÿæˆå‡½æ•°
            function createCSV(data) {
                const BOM = '\uFEFF'; // BOM ç”¨äºæ”¯æŒä¸­æ–‡
                const csvContent = data.map(row =>
                    row.map(cell => {
                        // å¤„ç†æ¯ä¸ªå•å…ƒæ ¼
                        const cellValue = String(cell ?? ''); // ä½¿ç”¨ ?? å¤„ç† null/undefined
                        // å¦‚æœåŒ…å«é€—å·ã€å¼•å·æˆ–æ¢è¡Œï¼Œéœ€è¦ç”¨å¼•å·åŒ…è£¹å¹¶è½¬ä¹‰
                        if (cellValue.includes(',') || cellValue.includes('"') || cellValue.includes('\n')) {
                            return `"${cellValue.replace(/"/g, '""')}"`;
                        }
                        return cellValue;
                    }).join(',')
                ).join('\n');
                return new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            }

            try {
                const { merchantData, unmatchedData } = splitResultData;
                const zip = new JSZipConstructor();

                console.log('å¼€å§‹æ·»åŠ  CSV æ–‡ä»¶åˆ° ZIP...');

                // ä¸ºæ¯ä¸ªå•†æˆ·åˆ›å»º CSV æ–‡ä»¶
                let fileCount = 0;
                for (const [merchantName, data] of Object.entries(merchantData)) {
                    if (data.length > 0) {
                        console.log(`æ·»åŠ  ${merchantName}: ${data.length} è¡Œæ•°æ®`);

                        try {
                            const csvBlob = createCSV(data);
                            zip.file(`${merchantName}.csv`, csvBlob);
                            fileCount++;
                            console.log(`âœ… ${merchantName} CSV æ·»åŠ æˆåŠŸ`);
                        } catch (err) {
                            console.error(`âŒ ${merchantName} CSV æ·»åŠ å¤±è´¥:`, err);
                            throw new Error(`ç”Ÿæˆ ${merchantName} CSV å¤±è´¥: ${err.message}`);
                        }
                    }
                }

                // æœªåˆ†é…æ•°æ®
                if (unmatchedData.length > 0) {
                    console.log(`æ·»åŠ  æœªåˆ†é…: ${unmatchedData.length} è¡Œæ•°æ®`);
                    try {
                        const csvBlob = createCSV(unmatchedData);
                        zip.file(`æœªåˆ†é….csv`, csvBlob);
                        fileCount++;
                        console.log(`âœ… æœªåˆ†é… CSV æ·»åŠ æˆåŠŸ`);
                    } catch (err) {
                        console.error(`âŒ æœªåˆ†é… CSV æ·»åŠ å¤±è´¥:`, err);
                    }
                }

                console.log(`æ€»å…±æ·»åŠ äº† ${fileCount} ä¸ª CSV æ–‡ä»¶åˆ° ZIP`);

                // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
                if (zip.files.length === 0) {
                    alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶');
                    return;
                }

                console.log('å¼€å§‹ç”Ÿæˆ ZIP blob...');

                // æ˜¾ç¤ºåŠ è½½æç¤º
                const loadingMsg = document.createElement('div');
                loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px 40px; border-radius: 8px; z-index: 9999; font-family: sans-serif;';
                loadingMsg.textContent = 'æ­£åœ¨æ‰“åŒ…æ–‡ä»¶...';
                document.body.appendChild(loadingMsg);

                // ç”Ÿæˆå¹¶ä¸‹è½½ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                console.log('ZIP blob ç”Ÿæˆå®Œæˆï¼Œå¤§å°:', zipBlob.size);

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const fileName = `å•†æˆ·æ‹†åˆ†ç»“æœ_${timestamp}.zip`;
                console.log('å¼€å§‹ä¸‹è½½:', fileName);

                saveAs(zipBlob, fileName);

                // ç§»é™¤åŠ è½½æç¤º
                document.body.removeChild(loadingMsg);

                console.log('âœ… ä¸‹è½½æˆåŠŸ');
                alert(`âœ… æ‰“åŒ…å®Œæˆï¼\n\nå·²ä¸‹è½½ ${zip.files.length} ä¸ª CSV æ–‡ä»¶\n\næ³¨æ„ï¼šCSV æ–‡ä»¶å¯ä»¥ç”¨ Excel ç›´æ¥æ‰“å¼€`);
            } catch (error) {
                console.error('âŒ ä¸‹è½½å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);

                // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMsg = 'ä¸‹è½½å¤±è´¥: ' + error.message;
                if (error.message.includes('XLSX')) {
                    errorMsg += '\n\nExcel å¤„ç†åº“å‡ºç°é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚';
                } else if (error.message.includes('JSZip')) {
                    errorMsg += '\n\nZIP æ‰“åŒ…åº“å‡ºç°é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚';
                } else if (error.message.includes('saveAs')) {
                    errorMsg += '\n\næ–‡ä»¶ä¿å­˜åº“å‡ºç°é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚';
                }
                errorMsg += '\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆæŒ‰ Command+Option+Jï¼‰';

                alert(errorMsg);
            }
        }

        // ==================== Excel å¤„ç† ====================

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsArrayBuffer(file);
            });
        }

        // ==================== å•†æˆ·ç®¡ç† ====================

        function initMerchantList() {
            renderMerchantList();
        }

        function renderMerchantList() {
            const container = document.getElementById('merchantList');

            if (merchants.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— å•†æˆ·é…ç½®</div>';
                return;
            }

            container.innerHTML = merchants.map((merchant, index) => `
                <div class="merchant-item">
                    <div class="merchant-name">ğŸ“ ${merchant.name} (${merchant.stores.length}ä¸ªé—¨åº—)</div>
                    <div class="merchant-stores">${merchant.stores.slice(0, 3).join('ã€')}${merchant.stores.length > 3 ? '...' : ''}</div>
                    <div class="merchant-actions">
                        <button class="btn btn-secondary" onclick="editMerchant(${index})" style="padding: 6px 12px; font-size: 13px;">ç¼–è¾‘</button>
                        <button class="btn btn-secondary" onclick="deleteMerchant(${index})" style="padding: 6px 12px; font-size: 13px; color: #F5222D; border-color: #F5222D;">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function showAddMerchantModal() {
            currentEditingMerchantIndex = -1;
            tempStoreList = [];
            document.getElementById('merchantModalTitle').textContent = 'æ·»åŠ å•†æˆ·';
            document.getElementById('merchantNameInput').value = '';
            document.getElementById('storeInput').value = '';
            renderStoreList();
            document.getElementById('merchantModal').classList.add('show');
        }

        function editMerchant(index) {
            currentEditingMerchantIndex = index;
            tempStoreList = [...merchants[index].stores];
            document.getElementById('merchantModalTitle').textContent = 'ç¼–è¾‘å•†æˆ·';
            document.getElementById('merchantNameInput').value = merchants[index].name;
            document.getElementById('storeInput').value = '';
            renderStoreList();
            document.getElementById('merchantModal').classList.add('show');
        }

        function deleteMerchant(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†æˆ·å—ï¼Ÿ')) {
                merchants.splice(index, 1);
                renderMerchantList();
                saveMerchantConfig();
            }
        }

        function addStore() {
            const input = document.getElementById('storeInput');
            const storeName = input.value.trim();

            if (storeName) {
                if (tempStoreList.includes(storeName)) {
                    alert('è¯¥é—¨åº—å·²å­˜åœ¨');
                    return;
                }
                tempStoreList.push(storeName);
                input.value = '';
                renderStoreList();
            }
        }

        function removeStore(index) {
            tempStoreList.splice(index, 1);
            renderStoreList();
        }

        function renderStoreList() {
            const container = document.getElementById('storeList');

            if (tempStoreList.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 16px;">æš‚æ— é—¨åº—</div>';
                return;
            }

            container.innerHTML = tempStoreList.map((store, index) => `
                <div class="store-item">
                    <span>${store}</span>
                    <span style="color: #F5222D; cursor: pointer; font-size: 18px;" onclick="removeStore(${index})">&times;</span>
                </div>
            `).join('');
        }

        function saveMerchant() {
            const name = document.getElementById('merchantNameInput').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å•†æˆ·åç§°');
                return;
            }

            if (tempStoreList.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªé—¨åº—');
                return;
            }

            const merchantData = { name, stores: [...tempStoreList] };

            if (currentEditingMerchantIndex >= 0) {
                merchants[currentEditingMerchantIndex] = merchantData;
            } else {
                merchants.push(merchantData);
            }

            renderMerchantList();
            saveMerchantConfig();
            closeModal('merchantModal');
        }

        // ==================== æ˜ å°„è§„åˆ™ç®¡ç† ====================

        function showMappingRulesModal() {
            const container = document.getElementById('mappingRulesContent');

            let html = '<table class="rules-table"><thead><tr><th style="width: 20%;">å­—æ®µå</th><th style="width: 35%;">æºæ ‡ç­¾</th><th style="width: 35%;">ç›®æ ‡å€¼</th></tr></thead><tbody>';

            for (const [fieldName, fieldMap] of Object.entries(mappingRules)) {
                const entries = Object.entries(fieldMap);
                const rowspan = entries.length;

                entries.forEach((entry, index) => {
                    const [sourceTag, targetValue] = entry;
                    html += '<tr>';
                    if (index === 0) {
                        html += `<td rowspan="${rowspan}">${fieldName}</td>`;
                    }
                    html += `<td><input type="text" value="${sourceTag}" onchange="updateMappingRule('${fieldName}', '${sourceTag}', 'source', this.value)"></td>`;
                    html += `<td><input type="text" value="${targetValue}" onchange="updateMappingRule('${fieldName}', '${sourceTag}', 'target', this.value)"></td>`;
                    html += '</tr>';
                });
            }

            html += '</tbody></table>';

            container.innerHTML = html;
            document.getElementById('mappingRulesModal').classList.add('show');
        }

        function updateMappingRule(fieldName, oldSourceTag, field, value) {
            const oldValue = mappingRules[fieldName][oldSourceTag];

            if (field === 'source') {
                // æ›´æ–°æºæ ‡ç­¾
                delete mappingRules[fieldName][oldSourceTag];
                mappingRules[fieldName][value] = oldValue;
            } else {
                // æ›´æ–°ç›®æ ‡å€¼
                mappingRules[fieldName][oldSourceTag] = value;
            }
        }

        function saveMappingRules() {
            localStorage.setItem('colmoMappingRules', JSON.stringify(mappingRules));
            closeModal('mappingRulesModal');
            alert('æ˜ å°„è§„åˆ™å·²ä¿å­˜');
        }

        // ==================== é…ç½®å¯¼å…¥å¯¼å‡º ====================

        function exportMappingRules() {
            const config = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                mappingRules: mappingRules
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            saveAs(blob, 'colmo_mapping_rules.json');
        }

        function importMappingRules() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const config = JSON.parse(event.target.result);
                            if (config.mappingRules) {
                                mappingRules = config.mappingRules;
                                localStorage.setItem('colmoMappingRules', JSON.stringify(mappingRules));
                                alert('æ˜ å°„è§„åˆ™å¯¼å…¥æˆåŠŸï¼');
                            } else {
                                alert('é…ç½®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                            }
                        } catch (error) {
                            alert('é…ç½®æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };

            input.click();
        }

        function exportMerchantConfig() {
            const config = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                merchants: merchants
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            saveAs(blob, 'colmo_merchant_config.json');
        }

        function importMerchantConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const config = JSON.parse(event.target.result);
                            if (config.merchants) {
                                merchants = config.merchants;
                                renderMerchantList();
                                saveMerchantConfig();
                                alert('å•†æˆ·é…ç½®å¯¼å…¥æˆåŠŸï¼');
                            } else {
                                alert('é…ç½®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                            }
                        } catch (error) {
                            alert('é…ç½®æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };

            input.click();
        }

        function saveMerchantConfig() {
            localStorage.setItem('colmoMerchants', JSON.stringify(merchants));
        }

        function loadSavedConfig() {
            try {
                const savedMappingRules = localStorage.getItem('colmoMappingRules');
                if (savedMappingRules) {
                    mappingRules = JSON.parse(savedMappingRules);
                }

                const savedMerchants = localStorage.getItem('colmoMerchants');
                if (savedMerchants) {
                    merchants = JSON.parse(savedMerchants);
                }
            } catch (error) {
                console.error('åŠ è½½ä¿å­˜çš„é…ç½®å¤±è´¥:', error);
            }
        }

        // ==================== å·¥å…·å‡½æ•° ====================

        function showProgress(type) {
            document.getElementById(type + 'Progress').style.display = 'block';
            document.getElementById(type + 'ProcessBtn').disabled = true;
        }

        function hideProgress(type) {
            document.getElementById(type + 'Progress').style.display = 'none';
            document.getElementById(type + 'ProcessBtn').disabled = false;
        }

        function updateProgress(type, percent, text) {
            document.getElementById(type + 'ProgressBar').style.width = percent + '%';
            document.getElementById(type + 'ProgressText').textContent = text;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });
    </script>
</body>
</html>
